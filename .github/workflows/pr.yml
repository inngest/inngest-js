name: PR checks

on:
  pull_request:
  workflow_dispatch:
  workflow_call:

concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_AUTH_TOKEN: nothing

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        nodeVersion: [14, 16, 18, lts]
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-and-build
      - run: volta run --node ${{ matrix.nodeVersion }} yarn test

  api_diff:
    name: Local API diff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-and-build
      - run: yarn run api-extractor run

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-and-build
      - run: yarn lint

  examples:
    name: Test examples
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo:
          - inngest/sdk-example-cloudflare-workers
    steps:
      # Checkout the repo
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-and-build

      # Checkout the example repo
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.EXAMPLES_GITHUB_TOKEN }}
          repository: ${{ matrix.repo }}
          path: examples/integration/${{ matrix.repo }}
          ref: main

      # Get the SDK ready and link it locally
      - run: yarn prelink
      - run: yarn link
        working-directory: dist

      # Install dependencies in the example repo
      - run: test -f yarn.lock && yarn install --frozen-lockfile || npm ci
        working-directory: examples/integration/${{ matrix.repo }}

      # Link the SDK
      - run: test -f yarn.lock && yarn link inngest || npm link inngest --force
        working-directory: examples/integration/${{ matrix.repo }}

      # Try to build the example
      - run: test -f yarn.lock && yarn build || npm run build
        working-directory: examples/integration/${{ matrix.repo }}

      # TODO Run the example and confirm SDK UI shows correctly
      # - run: npm run dev &
      # - run: sleep 5
      # - run: curl http://localhost:3000/api/inngest


